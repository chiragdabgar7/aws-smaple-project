{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "Mezzanine-powered blog with RDS, served with Nginx.",
  "Parameters" : {
    "KeyName" : {
      "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the instance",
      "Type" : "String"
    },
    "WebAMI": {
      "Type": "String"
    },
    "KeyPair": {
      "Type": "String"
    },
    "DBUser": {
      "Type": "String"
    },
    "DBPassword": {
      "Type": "String",
      "NoEcho": "TRUE"
    }
  },
  "Resources" : {
    "BlogDB" : { 
      "Type" : "AWS::RDS::DBInstance",
      "Properties" : {
        "DBSecurityGroups" : [ {"Ref" : "DBSecurityGroup"} ],
        "DBName" : "myblog",
        "AllocatedStorage" : 5,
        "DBInstanceClass" : "t2.micro",
        "Engine" : "MySQL",
        "EngineVersion" : "5.5",
        "MasterUsername" : { "Ref" : "DBUser" }, 
        "MasterUserPassword" : { "Ref" : "DBPassword" }
      },
      "DeletionPolicy" : "Snapshot" 
    },
    "DBSecurityGroup" : { 
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Allow inbound MySQL access from web instances",
        "SecurityGroupIngress" : [
          {
            "IpProtocol" : "tcp",
            "FromPort" : "3306",
            "ToPort" : "3306",
            "SourceSecurityGroupName" : { "Ref" : "WebSecurityGroup" }
          }
        ]
     },
    "WebInstance" : {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "SecurityGroups" : [ { "Ref" : "WebSecurityGroup" } ],
        "KeyName" : { "Ref" : "KeyPair",
        "ImageId" : { "Ref" : "WebAMI" },
         "UserData" : { 
           "Fn::Base64" : {
             "Fn::Join" : [ "", [
               "{\"db_endpoint\": \"", 
                { "Fn::GetAtt": [ "BlogDB", "Endpoint.Address" ] }, "\",",
               " \"db_user\": \"", { "Ref": "DBUser" }, "\",",
               " \"db_password\": \"", { "Ref": "DBPassword" }, "\" }"
            ] ]
          }
        }
      }
    },
    "WebSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Allow SSH and HTTP from anywhere",
        "SecurityGroupIngress" : [
          {
            "IpProtocol" : "tcp",
            "FromPort" : "22",
            "ToPort" : "22",
            "CidrIp" : "0.0.0.0/0"
          },
          {
            "IpProtocol" : "tcp",
            "FromPort" : "80",
            "ToPort" : "80",
            "CidrIp" : "0.0.0.0/0"
          }
        ]
      }
    }
  }
}
